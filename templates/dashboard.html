{% extends "base.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-6">
        <h2>Dashboard</h2>
    </div>
    <div class="col-md-6 text-end">
        <form action="" method="get" class="d-inline-flex">
            <input type="month" name="month" class="form-control me-2" value="{{ month }}">
            <button type="submit" class="btn btn-outline-primary">Filter</button>
        </form>
        <a href="{{ url_for("export_pdf") }}" class="btn btn-danger ms-2"><i class="fas fa-file-pdf"></i> PDF Report</a>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
            <div class="card-header">Income</div>
            <div class="card-body">
                <h3 class="card-title">{{ config.currency_symbol }}{{ income }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger mb-3">
            <div class="card-header">Expenses</div>
            <div class="card-body">
                <h3 class="card-title">{{ config.currency_symbol }}{{ expense }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3">
            <div class="card-header">Balance</div>
            <div class="card-body">
                <h3 class="card-title">{{ config.currency_symbol }}{{ balance }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Budget & Charts (Made Smaller) -->
<div class="row justify-content-center">
    <!-- Reduced column width from 6 to 5 -->
    <div class="col-lg-5 mb-4">
        <div class="card h-100">
            <div class="card-header">Monthly Budget ({{ config.currency_symbol }}{{ budget_limit }})</div>
            <div class="card-body">
                <p class="mb-1">Spent: {{ config.currency_symbol }}{{ expense }}</p>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar bg-{{ "danger" if budget_pct > 100 else "info" }}" 
                         role="progressbar" style="width: {{ budget_pct }}%">
                         {{ budget_pct | round(1) }}%
                    </div>
                </div>
                <hr>
                <h5>Savings Goals</h5>
                {% for goal in goals %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <small>{{ goal.name }}</small>
                        <small>{{ config.currency_symbol }}{{ goal.current }} / {{ goal.target }}</small>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: {{ (goal.current / goal.target * 100) }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <!-- Reduced column width from 6 to 5 -->
    <div class="col-lg-5 mb-4">
        <div class="card h-100">
            <div class="card-header">Expenses by Category</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const ctx = document.getElementById("expenseChart").getContext("2d");
    const chartData = {{ chart_data | tojson }};
    
    new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: chartData.map(d => d._id),
            datasets: [{
                data: chartData.map(d => d.total),
                backgroundColor: ["#ff6384", "#36a2eb", "#ffce56", "#4bc0c0", "#9966ff", "#ff9f40"],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        padding: 10,
                        font: { size: 10 }
                    }
                }
            }
        }
    });
</script>
{% endblock %}